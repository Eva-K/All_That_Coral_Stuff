---
title: "CoralTypePrediction"
author: "Eva Kovacs"
date: "18/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## packages

```{r what you need }
install.packages("tidyverse")
install.packages("janitor")
install.packages("skimr")
install.packages("stringr")
install.packages("data.table")
install.packages("ggthemes")
install.packages("RColorBrewer")
install.packages("gmodels")
install.packages("dplyr")
install.packages("plyr")
install.packages("foreign")
##install.packages('Rtools')
##install.packages('jwbannister/seepsVeg')


library(tidyverse) # use install.packages("tidyverse") if receive an error message
library(janitor) # use install.packages("janitor") if receive an error message
library(skimr)  # use install.packages("skimr") if receive an error message
library(stringr) # use install.packages("stringr") if receive an error message
library(data.table)
library(ggthemes)
library(RColorBrewer)
library(gmodels)
library(dplyr)
library(plyr)
library(foreign)
##library(Rtools)
##library(jwbannister/seepsVeg)

```


# Set the number of significant digits to preserve

```{r}

# Set
options(digits = 10)

#Check
options()

```

# Read in Files

```{r}
# Import file fom folder

head(CCMR_pred)

#  X1 Longitude Latitude pred.Bra pred.Mass pred.Plat
#  <dbl>     <dbl>    <dbl>    <dbl>     <dbl>     <dbl>
#1     1      146.    -17.8     36.2      64.4      5.06
```

# Rescale the values for each coral type (0-100)

```{r}
# Makea copy
CCMR <- CCMR_pred

# Change all negative prediction values to zero

setDT(CCMR)
for(j in grep('^pred', names(CCMR))){
 set(CCMR, i= which(CCMR[[j]]<0), j= j, value=0)
}

## Re-scale

# Calculate the SUM of the predicted coral types

CCMR<- CCMR%>%
  rowwise()%>%
  mutate(sum = sum(pred.Bra, pred.Mass, pred.Plat))

remove(CCMR_pred)

# Rescale the values

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(Bra0100 = (100*(pred.Bra/sum)))

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(Mass0100 = (100*(pred.Mass/sum)))

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(Plat0100 = (100*(pred.Plat/sum)))

CCMR<- CCMR%>%
  rowwise()%>%
  mutate(sum2 = sum(Bra0100, Mass0100, Plat0100))

max(CCMR$sum2)
min(CCMR$sum2)

# Write to file

CCMRScaled <- write.csv(CCMR, file = "C:/Users/uqekovac/Documents/R/Coding/GBRBenthic2020/CoralTypeMapping/CCMRScaled.csv")

```

# Calculate Dominant Coral Form (5%)

```{r 5% domiance}
CCMR <- CCMRScaled

CCMR <- mutate(CCMR, B = Bra0100)
CCMR <- mutate(CCMR, M = Mass0100)
CCMR <- mutate(CCMR, P = Plat0100)

#copy
CCMR2 <- CCMR

# recall
CCMR <- CCMR2

# calculate 5% dominance
CCMR <- CCMR%>%
  rowwise()%>%
  mutate(DomBy5 = fifelse((((B - M) >= 5) & ((B - P) >= 5)), "Branching", 
                          fifelse((((M - B) >= 5) & ((M - P) >= 5)), "Massive",
                         fifelse((((P - B) >=5) & ((P - M) >=5)), "Plate",
         
                         fifelse(((B <5) & (M == 0) & (P == 0)), "Branching",
                         fifelse(((M <5) & (B == 0) & (P == 0)), "Massive",
                         fifelse(((P <5) & (M == 0) & (B == 0)), "Plate", "Mixed")))))))
                         

unique(CCMR$DomBy5)


# Write to file

#RC_Mitch <- write.csv(RC_Mitch, file = "C:/Users/uqekovac/Documents/R/Coding/GBRBenthic2020/Output/RC_Heron2018_DomBen.csv")


```

# 15% Dominance

```{r 15% dominance}

#copy
CCMR3 <- CCMR

# recall
CCMR <- CCMR3

# calculate 15% dominance
CCMR <- CCMR%>%
  rowwise()%>%
  mutate(DomBy15 = fifelse((((B - M) >= 15) & ((B - P) >= 15)), "Branching", 
                          fifelse((((M - B) >= 15) & ((M - P) >= 15)), "Massive",
                         fifelse((((P - B) >=15) & ((P - M) >=15)), "Plate",
         
                         fifelse(((B <15) & (M == 0) & (P == 0)), "Branching",
                         fifelse(((M <15) & (B == 0) & (P == 0)), "Massive",
                         fifelse(((P <15) & (M == 0) & (B == 0)), "Plate", "Mixed")))))))
                         

unique(CCMR$DomBy15)


```

# Just plain dominant

```{r Dominant by value}

#copy
CCMR4 <- CCMR

# recall
CCMR <- CCMR4

# calculate 15% dominance
CCMR <- CCMR%>%
  rowwise()%>%
  mutate(Dominant = fifelse(((B > M) & (B > P)), "Branching",
                            fifelse(((M > B)  & (M > P)), "Massive",
                                     fifelse(((P > B) & (P > M)), "Plate","None"))))

unique(CCMR$Dominant)

```

# Tidy and save

```{r select rows and save}

# select rows
CCMR <- CCMR %>%
  select("X1", "Longitude", "Latitude", "B":"Dominant")

# Write to csv
CCMR <- write.csv(CCMR, file = "C:/Users/uqekovac/Documents/R/Coding/GBRBenthic2020/Output/CoralTypeMapping/CCMR_CT.csv")

```
# ##################
# ################## 
# Validation Points

# To extract any val points from the training points

```{r find the val points!}

####### To extract validation points
CCMR_Waves_val<- mutate(CCMR_Waves_val, Latitude=P_Lat)
CCMR_Waves_val<- mutate(CCMR_Waves_val, Longitude=P_Long)

CCMR_Val <- CCMR_Waves_val%>%
  select("Latitude":"Longitude")

# try to extract predictions for the val points 
# This shouldn't work as they weren't used for the modeling
# But some are pairing so delete those points

#CCMR_Valpreds <- merge(CCMR_Val, CCMR_simple, by=c("Longitude","Latitude"),all.x=TRUE, all.y=FALSE) 

CCMR_Valpreds <- left_join(CCMR_Val, CCMR_simple, by =c( "Longitude", "Latitude"))

# No CCMR val are joining - Yay

#######

```

# Create dominance for Validation

```{r Dominance val points}

CCMR_Waves_val <- mutate(CCMR_Waves_val, B = BrPerTot)
CCMR_Waves_val <- mutate(CCMR_Waves_val, M = MaPerTot)
CCMR_Waves_val <- mutate(CCMR_Waves_val, P = PPerTot)

#copy
CCMR <- CCMR_Waves_val%>%
  select("PeriPt", "Latitude":"P")

```

# Calculate Dominances

```{r 5%}

# calculate 5% dominance

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(DomBy5 = fifelse((((B - M) >= 5) & ((B - P) >= 5)), "Branching", 
                          fifelse((((M - B) >= 5) & ((M - P) >= 5)), "Massive",
                         fifelse((((P - B) >=5) & ((P - M) >=5)), "Plate",
         
                         fifelse(((B <5) & (M == 0) & (P == 0)), "Branching",
                         fifelse(((M <5) & (B == 0) & (P == 0)), "Massive",
                         fifelse(((P <5) & (M == 0) & (B == 0)), "Plate", "Mixed")))))))
                         

unique(CCMR$DomBy5)
```


```{r 15%}

# calculate 15% dominance

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(DomBy15 = fifelse((((B - M) >= 15) & ((B - P) >= 15)), "Branching", 
                          fifelse((((M - B) >= 15) & ((M - P) >= 15)), "Massive",
                         fifelse((((P - B) >=15) & ((P - M) >=15)), "Plate",
         
                         fifelse(((B <15) & (M == 0) & (P == 0)), "Branching",
                         fifelse(((M <15) & (B == 0) & (P == 0)), "Massive",
                         fifelse(((P <15) & (M == 0) & (B == 0)), "Plate", "Mixed")))))))
                         

unique(CCMR$DomBy15)
```


```{r 30%}

# calculate 30% dominance

CCMR <- CCMR%>%
  rowwise()%>%
  mutate(DomBy30 = fifelse((((B - M) >= 30) & ((B - P) >= 30)), "Branching", 
                          fifelse((((M - B) >= 30) & ((M - P) >= 30)), "Massive",
                         fifelse((((P - B) >=30) & ((P - M) >=30)), "Plate",
         
                         fifelse(((B <30) & (M == 0) & (P == 0)), "Branching",
                         fifelse(((M <30) & (B == 0) & (P == 0)), "Massive",
                         fifelse(((P <30) & (M == 0) & (B == 0)), "Plate", "Mixed")))))))
                         

unique(CCMR$DomBy30)
```

# Save

```{r}
CCMR <- write.csv(CCMR, file = "C:/Users/uqekovac/Documents/R/Coding/GBRBenthic2020/CoralTypeMapping/Wave_Predictions_per_region/Validation/CCMR_ValPts20210202.csv")
```

#Read in large DBF

```{r}

setwd("//sees-rsrc//Data/3DGBR_HabMap/Modelling/GEE_Output/Pixels_0-11")


# load the dbfs
dbf_paths <- list.files("CCMRCCMR25to10_cliptoSRSRS.dbf", full.names = T)
dbf_regions <- unlist(lapply(list.files("CCMR25to10_cliptoSRSRS.dbf"), function(x) strsplit(x, "_")[[1]][1]))
names(dbf_paths) <- dbf_regions
dbf_dfs <- mapply(load_dbf, dbf_paths, dbf_regions, SIMPLIFY = F)
dbf_dfs <- lapply(dbf_dfs, na.omit)

# alternate

CCMR <- read.dbf(system.file("CCMRCCMR25to10_cliptoSRSRS.dbf", package="foreign")[1])
str(x)
summary(x)


```

# Determine difference between CoralNet and ReefCLoud for CCMR

```{r}

# CoralNet CCMR output

CCMRct <- CCMR_Kalinda_Fleur_BENTHIC_DATA_submit_v2

CCMRtype <-
  CCMRct %>%
  rowwise()%>%
  mutate(
    Branching = (ACR_BRA + ACR_BRA_B_ + ACR_HIP + ACR_HIP_B_ + BRA_OTH + BRA_OTH_B_ +POCI+ POCI_B_ +POR_BRA+ POR_BRA_B_),
    Plate = (ACR_PE + ACR_PE_B_+ BRA_TAB_Ac+ BRA_TAB_B_ + TFP_RDG_Al +TFP_RDG_B_ +TFP_RND_Al +TFP_RND_B_),
    Massive = (BRA_DIG_Ac+ BRA_DIG_B_ +FAV_MUS +FAV_MUS_B_ +MASE_OTH +MASEoth_B_ + POR_ENC + POR_ENC_B_ + POR_MASS + POR_MAS_B_),
    Mixed = (ACR_OTH +ACR_OTH_B_+ OTH_HC+ OTH_HC_B_))

CCMRtype2 <-
  CCMRtype%>%
  select("Name", "Latitude", "Longitude", "Branching", "Massive", "Plate","Mixed")

print(count(CCMRtype2$Mixed))
print(count(CCMRtype2$Massive))
print(count(CCMRtype2$Branching))
print(count(CCMRtype2$Plate))

#CNb <- ggplot(CCMRtype2, aes(x=Branching)+
#                geom_histogram)

# ReefCloud CCMR output


CCMRrct <-summary_inference_2020June06_NoDups%>%
  select("image_name", "Branching","Massive","Plate")

CCMRrct <- mutate(CCMRrct, Name=image_name)
CCMRrct <-CCMRrct%>%
  select("Name", "Branching","Massive","Plate")
CCMRrct <- mutate(CCMRrct, BR=Branching)
CCMRrct <- mutate(CCMRrct, MA=Massive)
CCMRrct <- mutate(CCMRrct, PL=Plate)

CCMRrct <-CCMRrct%>%
  select("Name", "BR","MA","PL")

print(count(CCMRrct$Mixed))
print(count(CCMRrct$Massive))
print(count(CCMRrct$Branching))
print(count(CCMRrct$Plate))

ReefCloud <- CCMRrct
CoralNet <- CCMRtype2
# Compare the two outputs

Compare <- inner_join(ReefCloud, CoralNet, by = "Name")

# write file
 Compare <- write.csv(Compare, file = "C:/Users/uqekovac/Documents/R/Coding/GBRBenthic2020/CoralTypeMapping/AnnotatonComparison.csv")

#facet_wrap(Zone~., nc=2)+
```

# Plot frequencies

```{r}

# ReefCloud
rcb <- hist(Compare$BR, main = "", xlab = "ReefCloud Branching")
rcm <- hist(Compare$MA, main = "", xlab = "ReefCloud Massive")
rcp <- hist(Compare$PL, main = "", xlab = "ReefCloud Plate")

# CoralNet
cnb <- hist(Compare$Branching, main = "", xlab = "CoralNet Branching")
cnm <- hist(Compare$Massive, main = "", xlab = "CoralNet Massive")
cnp <- hist(Compare$Plate, main = "", xlab = "CoralNet Plate")
cnx <- hist(Compare$Mixed, main = "", xlab = "CoralNet Mixed")

rm(CCMR_Kalinda_Fleur_BENTHIC_DATA_submit_v2)
rm(CCMRrct)
rm(CCMRctype)
rm(CCMRtype2)
rm(Compare)
rm(CoralNet)
rm(cnb)
rm(cnm)
rm(cnp)
rm(cnx)
rm(summary_inference_2020June06_NoDups)
rm(ReefCloud)
rm(rcb)
rm(rcm)
rm(rcp)

```

